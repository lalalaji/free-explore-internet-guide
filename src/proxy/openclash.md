# openclash 教程

openclash 是 Openwrt 上的 clash 版本，拥有多种功能，但是配置起来比较麻烦。所以这里简单介绍一下重点功能。

如果对 clash 不够了解的话，可以先阅读一下[Clash 教程](./clash.md)这篇文章，再回过头来配置 openclash。

这篇文章主要介绍 openclash 的用法，所以不会对 Openwrt 做过多介绍，如果折腾出问题，请自行寻找解决办法。在折腾的过程中，建议将工作正常的路由器配置先备份一次，这样即使误操作出现一些问题，也可以使用配置迅速还原到正常状态，节约时间。

由于 openclash 比较折腾，所以没什么必要的话，直接使用[Clash for Windows](./cfw.md)就好了。除非你是个有强迫症、有一定技术且愿意折腾，而且有必须在路由器上设置透明代理的需求，才考虑使用 openclash。

## 开始使用

常见固件都已经将 openclash 整合到其中，无需额外安装即可使用。在 openwrt 菜单中，找到*服务->openclash*，就能打开 openclash 的配置页面了。由于配置极多，这里我就不上图了。

为方便起见，这里的配置均不涉及 IPv6 配置，如果有开启 IPv6 的需求，请查看其他博客。

### 添加订阅

点击上方的*配置文件订阅*就可以打开功能界面了。如果从机场获取的订阅是 clash 格式的，而且你不想修改机场的规则，就直接使用；如果机场提供的是其他类型的订阅，或者你想使用其它规则覆盖掉机场默认的规则，就启用订阅转换，然后选择一个自己喜欢的规则。在线订阅转换有泄露隐私的风险，自行决定要不要使用。

添加好订阅配置之后，点击下方的*更新配置*按钮，就能使用该配置文件启动 clash 了。有时候因为网络问题，部分规则文件会下载失败，可以稍等片刻再试试。只要订阅文件和转换设置没有问题，通常应该可以启动成功。

### 透明代理

openclash 有两种使用方法，第一种就是作为普通的代理服务器。

假设你的路由器 IP 为`192.168.1.2`，openclash 的 HTTP 端口或者混合端口是`7890`，那么在支持代理的程序上通过`192.168.1.2:7890`即可配置代理。

openclash 默认会生成用户名和密码，填写代理信息的时候，也需要顺便填写上，用户名和密码可以在 openclash 主页上找到。

第二种使用方法就是透明代理，可以让应用程序无感知的使用。

这种方法需要手动将要翻墙的设备上的默认网关和 DNS 服务器设置为`192.168.1.2`。设置成功之后，设备上应该无需做其他设置，就能正常的访问网络和翻墙了。

如果你在旁路由上使用 openclash，如果想要让所有设备都能实现透明代理，可以配置主路由器的网关和 DNS，指向旁路由。

如果主路由器没有这个设置，可以在旁路由器 openwrt 中寻找*网络->接口->DHCP->高级设置*，启用*强制*选项。这样新连接的设备就会自动通过旁路由器来分配默认网关和 DNS 服务器，以实现透明代理。

### 管理面板

openclash 内置了两个控制台可以用于查看 clash 的运行状态，以及调节节点配置，推荐使用 yacd 控制面板。参考[Clash 配置 外部控制器](./clash.md#外部控制器配置)。

## 进阶配置

点击 openclash 上方的全局设置，就能配置各种高级设置了。

### 模式设置

clash 有 redir-host 和 fake-ip 两种运行模式，推荐使用 fake-ip 模式。fake-ip 模式也有三种：

- 增强模式，使用 iptables 进行规则转发，性能最快，一般使用这种即可
- TUN 模式，使用 TUN 网卡进行转发，性能会慢一些，当同时开启了 docker 的时候，需要使用 TUN 模式才能正常转发 UDP 流量
- 混合模式，UDP 流量走 TUN 网卡，TCP 流量通过 iptables 转发

这几种模式可以都试试，通常情况下使用增强模式就行了。

路由本机代理、禁用 QUIC、仅代理命中规则流量、绕过中国大陆 IP(大陆 DNS 服务器填写 `223.5.5.5`等国内公共 DNS)最好都勾选上。

### DNS 设置

推荐勾选 Fake-IP 持久化、禁止 Dnsmasq 缓存 DNS。

### 规则设置(访问控制)

如果有自定义规则的需求，可以在这里添加想要使用的规则。

启用后出现两个编辑框，前者的规则会放到规则列表的前面，优先匹配；后者则会放到规则列表的后面，在其他规则之后来匹配，在其中填写想要设置直连或者是代理的规则即可，参考[Clash 教程 规则](./clash.md#规则)。

### 规则集管理

在 openclash 上方找到*规则集和策略组管理*，这里可以添加和修改规则集。第三方规则集内置了 ACL4SSR 等规则集，自定义规则集可以自由添加其他规则集。参考[Clash 教程 规则集](./clash.md#rule-provider)。
